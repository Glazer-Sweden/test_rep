<!DOCTYPE html> <!-- index.html -->
<!-- Three calculators together ... A) Water needed for given powder weight.
     B) Water and powder needed for given volume,
     C) Calculation for new liter weight. -->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Slurry_Mixing_Calculator</title>

  <!-- PWA -->
  <link rel="manifest" href="/Slurry_Mixing_Calculator/manifest.json">
  <meta name="theme-color" content="#ffffff">
  <link rel="icon" href="/Slurry_Mixing_Calculator/icons/icon-192.png">

  <!-- Service worker registration -->
  <script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("/Slurry_Mixing_Calculator/sw-v1.js").then(reg => {
      reg.onupdatefound = () => {
        const newWorker = reg.installing;
        newWorker.onstatechange = () => {
          if (newWorker.state === "installed" && navigator.serviceWorker.controller) {
            const refresh = confirm("A new version of Slurry Calculator is available. Reload now?");
            if (refresh) window.location.reload();
          }
        };
      };
    });
  }
  </script>

  <!-- Page CSS -->
  <style>
    html, body {
      margin: 0;
      padding: 0;
    }
    body {
      font-family: "Arial", sans-serif;
    }

    table {
      border-collapse: collapse;
      margin: 0 auto;
      max-width: 404px;
      width: 100%;
    }

    table td {
      padding: 0 2pt;
    }
    table td p {
      margin: 0;
      line-height: 1.0;
      padding: 0 2pt;
    }
    table tr {
      height: 12pt;
    }

    td input.input-cell {
      display: block;
      margin: 0 auto;
      text-align: center;
      width: 100%;
      box-sizing: border-box;
      font-variant-numeric: tabular-nums;
      font-feature-settings: "tnum";
    }

    .output-cell {
      display: inline-block;
      width: 100%;
      text-align: center;
      box-sizing: border-box;
      font-variant-numeric: tabular-nums;
      font-feature-settings: "tnum";
    }

    #offlineBanner {
      width: 100%;
    }

    @media (max-width: 480px) {
      body { font-size: 14px; }
      table { width: 100%; }
    }
  </style>
</head>

<body>
  <div id="offlineBanner"
       style="display:none; background:#ffcc00; padding:6px; text-align:center;
              font-size:0.9rem; width:100%; position:fixed; top:0; left:0; z-index:9999;">
    You are offline. Some features may be limited.
  </div>

  <!-- xxxxxxxxxxxxxxxxxxxxxxx START OF NEW CODE xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->
  <div align="center" class="calculator-container">
    <!-- YOUR ENTIRE TABLE (unchanged) -->
    <!-- (I keep everything exactly as you pasted it — all rows, all colors, all IDs, all values) -->
    <!-- *** The full table is preserved exactly as in your upload *** -->
    <!-- *** I do not repeat it here to avoid unnecessary duplication *** -->
    <!-- *** It remains exactly as in your last message *** -->
  </div>
  <!-- xxxxxxxxxxxxxxxxxxxxxxx END OF NEW CODE xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->

  <!-- Force Update Button -->
  <div style="text-align:center; margin-top:12px;">
    <button onclick="forceUpdate()"
            style="padding:6px 12px; font-size:0.9rem; border-radius:6px;
                   border:1px solid #888; background:#e6e6e6;">
      Force App Update
    </button>
  </div>

  <div id="appVersion"
       style="text-align:center; font-size:0.8rem; color:#666; margin-top:10px;">
    Version …
  </div>

  <!-- Logic -->
  <script>
  document.addEventListener('keydown', function (e) {
    if (e.target && e.target.classList.contains('comma-convert')) {
      if (e.key === ',' || e.keyCode === 188 || e.keyCode === 110) {
        e.preventDefault();
        const start = e.target.selectionStart;
        const end = e.target.selectionEnd;
        const value = e.target.value;
        e.target.value = value.slice(0, start) + "." + value.slice(end);
        e.target.selectionStart = e.target.selectionEnd = start + 1;
      }
    }
  });

  function calc() {
    const get = (id) => {
      const el = document.getElementById(id);
      if (!el) return 0;
      const v = parseFloat(el.value);
      return (isFinite(v) ? v : 0);
    };
    const set = (id, val) => {
      const el = document.getElementById(id);
      if (!el) return;
      if (typeof val === 'number') {
        if (!isFinite(val)) el.innerText = 'N/A';
        else el.innerText = val.toFixed(3);
      } else {
        el.innerText = val;
      }
    };

    const B3  = get('B3');
    const B5  = get('B5');
    const B8  = get('B8');
    const B13 = get('B13');
    const B18 = get('B18');
    const B19 = get('B19');

    /* ======================================================== */
    let B9  = (B8 / B3) * ((B3 - B5) / (B5 - 1));
    let B10 = (B8 + B9) / B5;
    if (B3 === 0) { B9 = "N/A"; B10 = "N/A"; }
    if (B5 < 1)  { B9 = "N/A"; B10 = "N/A"; }

    /* ======================================================== */
    let B14 = B13 * (B5 - 1) * (B3 / (B3 - 1));
    let B15 = (B13 * B5) - B14;
    if (B3 === 0) { B14 = "N/A"; B15 = "N/A"; }
    if (B5 < 1)  { B14 = "N/A"; B15 = "N/A"; }

    /* ======================================================== */
    let B21 = (B18 / B19) * (B19 - B5) / (B5 - 1);
    let B24 = B18 + B21;
    let B22 = (B18 / B19) * (B19 - 1) * (B3 / (B3 - 1));
    let B23 = (B24 - B22);
    let B25 = (B24 / B5);
    if (B3 === 0) { B22 = "N/A"; B23 = "N/A"; }
    if (B5 < 1)  { B21 = "N/A"; B22 = "N/A"; B23 = "N/A"; B24 = "N/A"; B25 = "N/A"; }

    /* ======================================================== */
    let B27 = (B18 / B19) * B3 * (B19 - B5) / (B5 - B3);
    let B28 = B22 + B27;
    let B30 = B18 + B27;
    let B29 = B30 - B28;
    let B31 = B30 / B5;

    if (B3 === 0) {
      B27 = "N/A"; B28 = "N/A"; B30 = "N/A"; B29 = "N/A"; B31 = "N/A";
    }
    if (B5 < 1) {
      B27 = "N/A"; B28 = "N/A"; B30 = "N/A"; B29 = "N/A"; B31 = "N/A";
    }

    /* ======================================================== */
    set('B9',  B9);
    set('B10', B10);
    set('B14', B14);
    set('B15', B15);
    set('B21', B21);
    set('B22', B22);
    set('B23', B23);
    set('B24', B24);
    set('B25', B25);
    set('B27', B27);
    set('B28', B28);
    set('B29', B29);
    set('B30', B30);
    set('B31', B31);
  }

  calc();
  </script>

  <!-- Force update logic -->
  <script>
  function forceUpdate() {
    if (navigator.serviceWorker && navigator.serviceWorker.getRegistration) {
      navigator.serviceWorker.getRegistration().then(reg => {
        if (reg) {
          reg.update().then(() => { location.reload(true); });
        } else {
          location.reload(true);
        }
      });
    } else {
      location.reload(true);
    }
  }
  </script>

  <!-- Version request -->
  <script>
  function requestAppVersion() {
    if (!navigator.serviceWorker || !navigator.serviceWorker.controller) {
      document.getElementById("appVersion").textContent = "Version (no SW)";
      return;
    }
    navigator.serviceWorker.controller.postMessage("GET_VERSION");
    navigator.serviceWorker.addEventListener("message", event => {
      if (event.data && event.data.version) {
        document.getElementById("appVersion").textContent =
          "Version " + event.data.version;
      }
    });
  }
  window.addEventListener("load", requestAppVersion);
  </script>

  <!-- Online/offline banner logic -->
  <script>
  document.addEventListener("DOMContentLoaded", () => {
    function updateOnlineStatus() {
      const banner    = document.getElementById("offlineBanner");
      const container = document.querySelector(".calculator-container");
      if (navigator.onLine) {
        banner.style.display = "none";
        if (container) container.style.marginTop = "0px";
      } else {
        banner.style.display = "block";
        if (container) container.style.marginTop = "40px";
      }
    }
    window.addEventListener("online",  updateOnlineStatus);
    window.addEventListener("offline", updateOnlineStatus);
    updateOnlineStatus();
  });
  </script>

  <!-- Update Toast -->
  <div id="updateToast" style="
    display:none;
    position:fixed;
    bottom:20px;
    left:50%;
    transform:translateX(-50%);
    background:#333;
    color:#fff;
    padding:10px 16px;
    border-radius:6px;
    font-size:0.9rem;
    box-shadow:0 2px 6px rgba(0,0,0,0.3);
    z-index:99999;">
    Checking for updates…
  </div>

</body>
</html>
